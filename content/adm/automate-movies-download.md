---
title: 'RSS → Bash → Transmission'
date: 2016-01-22T06:40:48+00:00
aliases:
  - /adm/automate-movies-download.html
featured_image: /images/posts/get-torrents-bash-wide.jpg
tags:
  - automate
  - bash
  - centos
  - cron
  - mbl
  - rss
  - torrent
  - transmission
---

Нахрен долгое вступление. Если на вопрос "Нравится автоматизировать и любишь посмотреть кино?" ты неосознанно ответишь положительно, то прочитанное здесь - тебе понравится. Итак, наверняка у тебя есть своя железяка, которая стоит дома/офисе где-то в уголочке и выполняет роль файлошары/торрентокачалки и Джа знает ещё чего.

<!--more-->

Выглядеть железяка может, например, так:

![photo](https://hsto.org/webt/jh/6r/op/jh6ropq-xh3wzvjgerxtpi_06t4.jpeg)

Hardware |
-------- | -----
Мать | [MSI C847IS-P33](http://ru.msi.com/product/motherboard/C847ISP33.html#hero-overview)
Камень | Распаян на плате, Intel(R) Celeron(R) CPU 847 @ 1.10GHz / 2 ядра
Память | DDR3 @ 2 Gb
SDD (система) | Kingston @ 8 Gb
HDD (данные) | WG Green @ 2 Tb

## Что такое RSS torrent?

Это RSS лента, в которой вместо привычных новостей публикуются ссылки на .torrent файлы выбранной тобой тематики. Придумали это давно, и прогрессивный народ активно этим пользуется. Есть даже сервисы, такие как:

* [torrentrss.net](http://torrentrss.net/)
* [litr.cc](http://litr.cc/)
* [NoNaMe Club](http://nnm-club.me/forum/viewtopic.php?t=192770)

Которые этим и живут. Конечный пользователь приходит, выбивает интересный ему контент, получает ссылку на свою ленту, кормит её своему торрент-клиенту (_который в свою очередь должен поддерживать torrent rss_) - получая в конечном счете новые серии любимых сериалов/фильмов определенной тематики почти без задержки и лишних действий. Пиздец как удобненько.

## Почему bash и Transmission?

Раньше скрипт был [написан на питоне]({{< ref "automate-torrents-downloads.md" >}}). Но поставить его - задача не из самых тривиальных, особенно на стареньких системах. Зависимости, сторонние библиотеки.. А bash - он считай что везде, да и в конкретной реализации нет никаких экзотичных требований.

Transmission в свою очередь - потому как очень шустрый, имеет адекватную веб-морду, да и с поддержкой у него - всё в порядке. Единственное серьезное "но" - это отсутствие поддержки RSS, и как раз исправлением этого недочета мы сейчас и займемся. Наш скрипт будет запускаться кроном с заданным интервалом, ссылки на .torrent файлы из RSS будут нежно извлекаться, записываться в файл, и передаваться RPC Transmission.

Его настройки:

Параметр | Описание
-------- | --------
`USE_WGET` | Использовать `wget` (<em>принимает значения `1`|``</em>)
`WGET_PATH` | Путь до расположения `wget` (<em>строка</em>)
`USE_CURL` | Использовать `curl` (<em>принимает значения `1`|``</em>)
`CURL_PATH` | Путь до расположения `curl` (<em>строка</em>)
`USE_PROXY` | Использовать прокси (да/нет) (<em>принимает значения `1`|``</em>)
`PROXY_SCHEME` | Схема прокси (<em>строка, например `http`, `https`, `socks` и т.п.</em>)
`PROXY_ADDR` | Адрес прокси (<em>строка</em>)
`PROXY_PORT` | Порт прокси (<em>строка</em>)
`PROXY_USER` | Пользователь на прокси (<em>строка</em>)
`PROXY_PASS` | Пароль пользователя на прокси (<em>строка</em>)
`FEED_URLS_AND_DIRS` | Массив со ссылками на RSS ленты. Что очень важно - указывается URL первой ленты, а следующим элементом массива - директория, куда скачивать из URL торренты. И так далее
`TRANSMISSION_REMOTE` | Путь до `transmission-remote` (<em>строка</em>)
`TRANSMISSION_RPC_USER` | Пользователь `transmission-remote` (<em>строка</em>)
`TRANSMISSION_RPC_PASS` | Пароль пользователя `transmission-remote` (<em>строка</em>)
`TRANSMISSION_RPC_HOST` | Адрес `transmission-remote` (<em>строка</em>)
`TRANSMISSION_RPC_PORT` | Порт `transmission-remote` (<em>строка</em>)
`REMOVE_TRANSMISSION_COMPLETED_TASKS` | Удалять уже завершенные закачки из Transmission (<em>принимает значения `1`|``</em>)
`HISTORY_FILE` | Путь до текстового файла для хранения ссылок, которые были переданы в `transmission-remote` (<em>строка</em>)
`COLOR_OUTPUT` | Использовать цветную выдачу в `STDOUT` (<em>принимает значения `1`|``</em>)

Пример настройки `FEED_URLS_AND_DIRS`:

```bash
FEED_URLS_AND_DIRS=(\
  'http://link.to/rss/feed1.xml' '/path/to/dir1/' \
  'http://link.to/rss/feed2.xml' '/path/to/dir2/' \
  'http://link.to/rss/feed3.xml' '/path/to/dir3/' \
);
```

{{< gist tarampampam 6f44cef4ffc8f1def8d2 >}}

## Установка

Переходим в нужную директорию и скачиваем исходник скрипта (_потребуются `wget` и `unzip`_):

```bash
$ wget -O src.zip https://goo.gl/TFfcgU; unzip src.zip; rm -f src.zip
$ mv ./6f*d2-master/* ./; rm -Rf ./6f*d2-master/
$ ls -l *.sh
-rw-r--r-- 1 kot nginx 10598 янв 22 10:21 get_torrents.sh
```

После чего открываем скрипт любимым редактором, и выполняем его настройку. Все настройки находятся в самом начале скрипта. Проверяем, делаем тестовые запуски. После того, как убедимся что всё работает как надо - добавляем запуск скрипта в крон:

```bash
$ crontab -e
# Добавляем примерно следующую строку:
  5     8-23   *     *    * /usr/bin/nice -n 15 /usr/bin/bash ~/get_torrents.sh

# -     -      -     -    - ----------------------------------------------------------------
# |     |      |     |    |
# |     |      |     |    +----- day of week (0 - 6) (Sunday=0)
# |     |      |     +------- month (1 - 12)
# |     |      +--------- day of month (1 - 31)
# |     +----------- hour (0 - 23)
# +------------- min (0 - 59)
```

Запускать через `nice` вовсе не обязательно, но как-то правильнее, что-ли. Наслаждайся, мудачина :)

### + Bonus

Просто как рекомендация, не более. Есть такое средство для организации и просмотра (_в браузере или через DLNA_) библиотеки твоих фильмов/сериалов как **Plex**. Очень рекомендую - вещь просто ахрененная. Написана на питоне, не требует установленного веб-сервера и СУБД. Просто ставишь - и пользуешься. Подробнее об этом [почитай здесь](https://plex.tv/features), да и вообще - поищи в сети ссылки и описания. Ещё раз - это простая рекомендация, но проверенная лично.
